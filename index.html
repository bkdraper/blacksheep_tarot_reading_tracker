<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="version" content="v3.99.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tarot Reading Tracker" id="appleTitle">
    <meta name="application-name" content="Tarot Reading Tracker" id="appName">
    <meta name="msapplication-starturl" content="/">
    <link rel="icon" type="image/png" id="favicon" href="/logo192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <title>Tarot Reading Tracker</title>

    <script>
        // Global app title variable
        function isDevelopmentMode() {
            return window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.hostname.startsWith('192.168.') ||
                   window.location.hostname.startsWith('10.') ||
                   window.location.port === '8080' ||
                   window.location.protocol === 'file:' ||
                   window.location.search.includes('dev=true');
        }
        window.APP_TITLE = isDevelopmentMode() ? '[DEV] Tarot Reading Tracker' : 'Tarot Reading Tracker';
        window.APP_LOGO = isDevelopmentMode() ? '/logo192-dev.png' : '/logo192.png';
        document.title = window.APP_TITLE;
        document.getElementById('favicon').href = window.APP_LOGO;
        document.getElementById('appleTitle').content = window.APP_TITLE;
        document.getElementById('appName').content = window.APP_TITLE;
        // Set header title after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            const headerTitle = document.getElementById('headerTitle');
            if (headerTitle) headerTitle.textContent = window.APP_TITLE;
        });
    </script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1 id="headerTitle">Tarot Reading Tracker</h1>
        <div class="header-actions">
            <span class="version-badge">v3.99.0</span>
            <button class="settings-btn" onclick="settings.openDrawer()" title="Settings"><i class="fas fa-cog"></i></button>
        </div>
    </header>
    <div class="container">
        <div class="event-settings">
            <div class="settings-header" onclick="settings.toggleSettings()">
                <span>Event Settings</span>
                <span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="user-section">
                    <div class="input-group">
                        <label for="user">User:</label>
                        <button id="userBtn" onclick="session.showUserSelection()" class="user-btn">Select User...</button>
                    </div>
                    <button class="btn-load-session" onclick="session.showLoadSession()">Load Session</button>
                </div>

                <hr style="border: none; border-top: 1px solid #ddd; margin: 15px 0;">

                <div class="input-group">
                    <label for="price">Reading<br>Price:</label>
                    <div class="price-input-container">
                        <span class="dollar-sign">$</span>
                        <input type="number" id="price" value="40" step="0.01" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label for="location">Event<br>Name:</label>
                    <input type="text" id="location" placeholder="(City, Season, Year, etc.)">
                </div>

                <div class="input-group">
                    <label for="sessionDate">Event<br>Date:</label>
                    <input type="date" id="sessionDate" placeholder="Select event date" onclick="this.showPicker()">
                </div>

                <hr style="border: none; border-top: 1px solid #ddd; margin: 15px 0;">

                <div id="requiredFieldsNote" style="font-size: 11px; color: #dc3545; text-align: center; margin-bottom: 10px;">* Fill in the red-outlined fields to create a new session</div>

                <div class="input-group">
                    <button class="btn-create-session inactive" onclick="session.handleCreateSession()">Create Session</button>
                    <button class="btn-new-session" onclick="session.startNewSession()" style="display: none;">New Session</button>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-add" onclick="readingsManager.addReading()">+ Add Reading</button>
            <button class="btn-remove" onclick="readingsManager.removeReading()">-</button>
        </div>

        <div class="totals">
            <table class="totals-table">
                <tr>
                    <td><i class="fas fa-book-open" style="margin-right: 8px;"></i>Readings:</td>
                    <td><span id="readingCount">0</span></td>
                </tr>
                <tr>
                    <td><i class="fas fa-coins" style="margin-right: 8px;"></i>Base Total:</td>
                    <td>$<span id="baseTotal">0.00</span></td>
                </tr>
                <tr>
                    <td><i class="fas fa-hand-holding-usd" style="margin-right: 8px;"></i>Tips Total:</td>
                    <td>$<span id="tipsTotal">0.00</span></td>
                </tr>
            </table>
            <div class="grand-total"><i class="fas fa-wallet" style="margin-right: 8px;"></i>Total: $<span id="grandTotal">0.00</span></div>
        </div>

        <div class="readings-list">
            <h3>Readings Log</h3>
            <div id="readingsList"></div>
        </div>

        <div class="timer">
            <h3>Timer</h3>
            <div class="timer-controls">
                <button class="arrow-btn" onclick="timer.adjustTime(-1)"><i class="fas fa-minus"></i></button>
                <input type="number" class="timer-input" id="timerInput" value="15" min="0" max="99" inputmode="numeric">
                <button class="arrow-btn" onclick="timer.adjustTime(1)"><i class="fas fa-plus"></i></button>
            </div>
            <div class="timer-canvas-container">
                <canvas id="timerCanvas" class="timer-canvas" width="300" height="300"></canvas>
            </div>
            <div class="timer-display" id="timerDisplay" style="display: none;">15:00</div>
            <div class="timer-buttons">
                <button class="timer-btn start-btn" onclick="timer.start()">Start</button>
                <button class="timer-btn pause-btn" onclick="timer.pause()">Pause</button>
                <button class="timer-btn reset-btn" onclick="timer.reset()">Reset</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Sheet -->
    <div id="paymentOverlay" class="payment-overlay" onclick="readingsManager.closePaymentSheet()"></div>
    <div id="paymentSheet" class="payment-sheet">
        <div class="payment-sheet-header">
            <h3>Select Payment Method</h3>
            <button class="modal-close" onclick="readingsManager.closePaymentSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="payment-sheet-options" id="paymentOptions">
            <!-- Payment options populated dynamically -->
        </div>
    </div>

    <!-- Source Sheet -->
    <div id="sourceOverlay" class="payment-overlay" onclick="readingsManager.closeSourceSheet()"></div>
    <div id="sourceSheet" class="payment-sheet">
        <div class="payment-sheet-header">
            <h3>Select Source</h3>
            <button class="modal-close" onclick="readingsManager.closeSourceSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="payment-sheet-options" id="sourceOptions">
            <!-- Source options populated dynamically -->
        </div>
    </div>

    <!-- User Selection Sheet -->
    <div id="userOverlay" class="payment-overlay" onclick="session.hideUserSelection()"></div>
    <div id="userSheet" class="session-sheet">
        <div class="session-sheet-header">
            <h3>Select User</h3>
            <button class="modal-close" onclick="session.hideUserSelection()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="userList"></div>
            <button onclick="session.addNewUser()" class="btn-add-user">+ Add New User</button>
        </div>
    </div>

    <!-- Load Session Sheet -->
    <div id="sessionOverlay" class="payment-overlay" onclick="session.closeSessionSheet()"></div>
    <div id="sessionSheet" class="session-sheet">
        <div class="session-sheet-header">
            <h3>Load Existing Session</h3>
            <button class="modal-close" onclick="session.closeSessionSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="sessionsList"></div>
        </div>
    </div>

    <!-- Payment Methods Customization Sheet -->
    <div id="paymentMethodsOverlay" class="payment-overlay" onclick="settings.closePaymentMethodsSheet()"></div>
    <div id="paymentMethodsSheet" class="payment-methods-sheet">
        <div class="session-sheet-header">
            <h3>Customize Payment Methods</h3>
            <button class="modal-close" onclick="settings.closePaymentMethodsSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="paymentMethodsList"></div>
            <button onclick="settings.addPaymentMethod()" class="add-payment-method">+ Add Payment Method</button>
        </div>
    </div>

    <!-- Sources Customization Sheet -->
    <div id="sourcesOverlay" class="payment-overlay" onclick="settings.closeSourcesSheet()"></div>
    <div id="sourcesSheet" class="payment-methods-sheet">
        <div class="session-sheet-header">
            <h3>Customize Sources</h3>
            <button class="modal-close" onclick="settings.closeSourcesSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="sourcesList"></div>
            <button onclick="settings.addSource()" class="add-payment-method">+ Add Source</button>
        </div>
    </div>

    <!-- Gpsy Chat Drawer -->
    <div id="gpsyOverlay" class="settings-overlay" onclick="gpsyChat.close()"></div>
    <div id="gpsyDrawer" class="gpsy-drawer">
        <div class="gpsy-header">
            <h2 style="display: flex; align-items: center; gap: 10px;">
                <div class="gpsy-avatar" style="width: 28px; height: 28px; background: transparent;">
                    <img src="" id="gpsyHeaderLogo" alt="ChatGPSY">
                </div>
                ChatGPSY
            </h2>
            <button class="modal-close" onclick="gpsyChat.close()"><i class="fas fa-times"></i></button>
        </div>
        <div id="gpsyMessages" class="gpsy-messages"></div>
        <div id="gpsyQuickActions" class="gpsy-quick-actions" style="display: none;">
            <!-- Quick action chips populated dynamically -->
        </div>
        <div class="gpsy-input-container">
            <input type="text" id="gpsyInput" placeholder="Ask about your readings..." onkeydown="if(event.key==='Enter') gpsyChat.send()">
            <button id="gpsySendBtn" onclick="gpsyChat.send()" class="gpsy-send-btn">Send</button>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div id="settingsOverlay" class="settings-overlay" onclick="settings.closeDrawer()"></div>
    <div id="settingsDrawer" class="settings-drawer">
        <div class="settings-drawer-header">
            <h2>Settings</h2>
            <button class="modal-close" onclick="settings.closeDrawer()"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-drawer-content">
            <!-- ChatGPSY -->
            <div class="settings-section" style="border-bottom: 2px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
                <button class="tracker-buddy-btn" onclick="gpsyChat.open()">
                    <div class="gpsy-avatar" style="width: 32px; height: 32px; background: transparent;">
                        <img src="" id="buddyLogo" alt="ChatGPSY">
                    </div>
                    <span style="font-size: 16px; font-weight: 600;">ChatGPSY</span>
                </button>
            </div>

            <!-- App Preferences -->
            <div class="settings-section">
                <h3>App Preferences</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Sound Alerts</div>
                        <div class="setting-description">Timer alarm sounds</div>
                    </div>
                    <div class="toggle-switch" id="soundToggle" onclick="settings.toggleSetting('sound')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Haptic Feedback</div>
                        <div class="setting-description">Vibration on button presses</div>
                    </div>
                    <div class="toggle-switch" id="hapticToggle" onclick="settings.toggleSetting('haptic')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Timer Notifications</div>
                        <div class="setting-description">Push notifications when timer expires</div>
                    </div>
                    <div class="toggle-switch" id="timerNotificationsToggle" onclick="settings.toggleSetting('timerNotifications')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Dark Mode</div>
                        <div class="setting-description">Dark theme for evening events</div>
                    </div>
                    <div class="toggle-switch" id="darkModeToggle" onclick="settings.toggleSetting('darkMode')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Default Timer</div>
                        <div class="setting-description">Default timer duration</div>
                    </div>
                    <select class="settings-select" id="defaultTimer" onchange="settings.updateSetting('defaultTimer', this.value)">
                        <option value="5">5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="15" selected>15 minutes</option>
                        <option value="20">20 minutes</option>
                        <option value="30">30 minutes</option>
                    </select>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="settings-section">
                <h3>Payment Methods</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Available Methods</div>
                        <div class="setting-description">Customize payment options</div>
                    </div>
                    <button class="settings-button" onclick="settings.customizePaymentMethods()">Customize</button>
                </div>
            </div>

            <!-- Sources -->
            <div class="settings-section">
                <h3>Sources</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Available Sources</div>
                        <div class="setting-description">Customize source options</div>
                    </div>
                    <button class="settings-button" onclick="settings.customizeSources()">Customize</button>
                </div>
            </div>

            <!-- Data & Export -->
            <div class="settings-section">
                <h3>Data & Export</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Export Data</div>
                        <div class="setting-description">Download session data as CSV</div>
                    </div>
                    <button class="settings-button" onclick="settings.exportData()">Export</button>
                </div>
            </div>

            <!-- Analytics -->
            <div class="settings-section">
                <h3>Analytics & Notifications</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Daily Summary</div>
                        <div class="setting-description">End of day notifications</div>
                    </div>
                    <div class="toggle-switch" id="dailySummaryToggle" onclick="settings.toggleSetting('dailySummary')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Weekend Goals</div>
                        <div class="setting-description">Earnings milestone alerts</div>
                    </div>
                    <div class="toggle-switch" id="weekendGoalsToggle" onclick="settings.toggleSetting('weekendGoals')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Best Day Alerts</div>
                        <div class="setting-description">Peak performance notifications</div>
                    </div>
                    <div class="toggle-switch" id="bestDayToggle" onclick="settings.toggleSetting('bestDay')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Tip Trends</div>
                        <div class="setting-description">Tip analysis notifications</div>
                    </div>
                    <div class="toggle-switch" id="tipTrendsToggle" onclick="settings.toggleSetting('tipTrends')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Peak Time Alerts</div>
                        <div class="setting-description">Busy time notifications</div>
                    </div>
                    <div class="toggle-switch" id="peakTimeToggle" onclick="settings.toggleSetting('peakTime')"></div>
                </div>
            </div>

            <!-- App Updates -->
            <div class="settings-section">
                <h3>App Updates</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Check for Updates</div>
                        <div class="setting-description">Manually check for new app versions</div>
                    </div>
                    <button class="settings-button" onclick="checkForUpdates()">Check</button>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Clear Cache</div>
                        <div class="setting-description">Clear all cached files and reload</div>
                    </div>
                    <button class="settings-button" onclick="clearCache()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2?v=2"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1691.0.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://uuindvqgdblkjzvjsyrz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_MsdJm2VITIPWik4dBPErrw_QjfIsKe9';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Service worker registration for PWA with message handling
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/serviceWorker.js')
                .then(registration => {
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                    // Register for periodic background sync (requires user permission)
                    if ('periodicSync' in window.ServiceWorkerRegistration.prototype) {
                        registration.periodicSync.register('backup-readings', {
                            minInterval: 24 * 60 * 60 * 1000 // 24 hours
                        }).catch(() => {});
                    }
                    
                    // Request notification permission
                    if ('Notification' in window && 'serviceWorker' in navigator) {
                        Notification.requestPermission();
                    }
                })
                .catch(() => {});
            
            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SYNC_READINGS') {
                    handleBackgroundSync();
                } else if (event.data.type === 'BACKUP_READINGS') {
                    handleBackgroundBackup();
                } else if (event.data.type === 'RESET_TIMER') {
                    timer.handleTimerReset();
                }
            });
        }

        
        // Central Session Store
        // SESSION STORE CLASS - See modules/session-store.js
        // Timer class extracted to modules/timer.js
        // SettingsStore class extracted to modules/settings-store.js

        // Date normalization utility
        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            // Convert YYYY-MM-DD or YY-MM-DD to MM/DD/YYYY
            if (dateStr.match(/^\d{2,4}-\d{2}-\d{2}$/)) {
                let [year, month, day] = dateStr.split('-');
                if (year.length === 2) year = '20' + year;
                return `${parseInt(month)}/${parseInt(day)}/${year}`;
            }
            return dateStr; // Already in MM/DD/YYYY or other format
        }

        // Initialize stores
        // SESSION STORE CLASS - See modules/session-store.js
        
        // Analytics & Notification System - See modules/analytics-notifier.js

        
        // Background sync handler
        async function handleBackgroundSync() {
            try {
                if (session.sessionId && session.readings.length > 0) {
                    await session.save();
                }
            } catch (error) {}
        }
        
        // Background backup handler
        async function handleBackgroundBackup() {
            try {
                // Create backup in localStorage with timestamp
                const backup = {
                    timestamp: new Date().toISOString(),
                    sessionData: {
                        sessionId: session.sessionId,
                        location: session.location,
                        selectedDay: session.selectedDay,
                        price: session.price,
                        readings: session.readings
                    }
                };
                localStorage.setItem('readingTracker_backup', JSON.stringify(backup));
            } catch (error) {}
        }
        
        // Register for background sync when going offline
        function registerBackgroundSync() {
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('background-sync-readings');
                }).catch(() => {});
            }
        }
        
        // Send push notification (for testing)
        function sendTestNotification() {
            
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in browser settings.');
                return;
            }
            
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showTestNotification();
                    } else {
                        alert('Notification permission denied');
                    }
                });
            } else if (Notification.permission === 'granted') {
                showTestNotification();
            }
        }
        
        function showTestNotification() {
            // Try direct notification first
            try {
                new Notification('Test Notification', {
                    body: 'Direct browser notification test',
                    icon: '/logo192.png'
                });
            } catch (err) {}
            
            // Also try service worker notification
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification(window.APP_TITLE, {
                        body: 'Test notification - this should appear on desktop!',
                        icon: '/logo192.png',
                        badge: '/logo192.png',
                        vibrate: [100, 50, 100],
                        tag: 'test-notification',
                        actions: [
                            { action: 'open', title: 'Open App' },
                            { action: 'close', title: 'Close' }
                        ]
                    }).catch(() => {});
                }).catch(() => {});
            }
        }
        
        function fallbackNotification() {
            new Notification(window.APP_TITLE, {
                body: 'Test notification - fallback method',
                icon: '/logo192.png'
            });
        }

        function showUpdateNotification() {
            const updateBar = document.createElement('div');
            updateBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #007bff;
                color: white;
                padding: 12px;
                text-align: center;
                z-index: 10000;
                font-size: 14px;
            `;
            updateBar.innerHTML = `
                New version available! 
                <button onclick="updateApp()" style="background: white; color: #007bff; border: none; padding: 4px 8px; margin-left: 8px; border-radius: 4px; cursor: pointer;">Update Now</button>
                <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 4px 8px; margin-left: 4px; border-radius: 4px; cursor: pointer;">Later</button>
            `;
            document.body.appendChild(updateBar);
        }
        
        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    } else {
                        // Force reload if no waiting worker
                        window.location.reload(true);
                    }
                }).catch(() => {
                    // Fallback to hard reload
                    window.location.reload(true);
                });
            } else {
                window.location.reload(true);
            }
        }

        function checkForUpdates() {
            if (settings.get('haptic')) vibrate([50]);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        showSnackbar('Checking for updates...', 'info');
                        registration.update().then(() => {
                            setTimeout(() => {
                                showSnackbar('No updates available', 'success');
                            }, 1000);
                        }).catch(() => {
                            showSnackbar('Update check failed', 'error');
                        });
                    } else {
                        showSnackbar('Service worker not available', 'error');
                    }
                }).catch(() => {
                    showSnackbar('Update check failed', 'error');
                });
            } else {
                showSnackbar('Updates not supported', 'error');
            }
        }

        function clearCache() {
            if (settings.get('haptic')) vibrate([50]);
            
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                showSnackbar('Cache cleared! Reloading...', 'success');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            } else {
                showSnackbar('Service worker not available', 'error');
            }
        }





        // Initialize audio context on first user interaction
        document.addEventListener('click', () => timer.initAudio(), { once: true });

        document.getElementById('timerInput').addEventListener('input', function() {
            if (!timer.isRunning) {
                timer.seconds = parseInt(this.value) * 60;
            }
        });

        // Initialize canvas on page load
        window.addEventListener('load', function() {
            timer.initCanvas();
            
            // Set default timer from settings
            const defaultMinutes = settings.get('defaultTimer');
            document.getElementById('timerInput').value = defaultMinutes;
            timer.seconds = defaultMinutes * 60;
            
            // Set buddy logo and header logo
            document.getElementById('buddyLogo').src = window.APP_LOGO;
            document.getElementById('gpsyHeaderLogo').src = window.APP_LOGO;
        });

        document.getElementById('price').addEventListener('input', function() {
            session.price = parseFloat(this.value) || 0;
        });

        document.getElementById('location').addEventListener('input', function() {
            session.location = this.value;
        });
        
        document.getElementById('sessionDate').addEventListener('input', function() {
            session.sessionDate = this.value;
        });


        // Check for saved session on page load
        window.addEventListener('load', async function() {
            const saved = localStorage.getItem('readingTracker');
            if (saved) {
                const state = JSON.parse(saved);
                const location = state.location || 'Unknown location';
                const date = state.sessionDate || state.selectedDay || 'Unknown date';
                const message = `I have saved data from ${location} on ${date}. Would you like to load that data? (OK) or start a new session? (Cancel)`;
                if (confirm(message)) {
                    session.loadFromStorage();
                } else {
                    session.startOver();
                }
            } else {
                // Initialize UI on first load
                session.updateUI();
            }
        });

        // Close sheets when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('sessionOverlay')) {
                session.closeSessionSheet();
            }
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            handleBackgroundSync();
        });
        
        window.addEventListener('offline', () => {
            registerBackgroundSync();
        });
        
        // Page visibility change - backup data when app goes to background (throttled)
        let lastBackupTime = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                const now = Date.now();
                // Only backup once per minute to prevent spam
                if (now - lastBackupTime > 60000) {
                    handleBackgroundBackup();
                    lastBackupTime = now;
                }
            }
        });
        

        

    </script>
    
    <script src="modules/utils.js"></script>
    <script src="modules/timer.js"></script>
    <script src="modules/session-store.js"></script>
    <script src="modules/settings-store.js"></script>
    <script src="modules/gpsy-chat.js"></script>
    <script src="modules/readings-manager.js"></script>
    <script src="modules/analytics-notifier.js"></script>
    
    <script>
        // ========================================
        // INITIALIZATION
        const settings = new SettingsStore();
        const session = new SessionStore();
        const timer = new Timer();
        const gpsyChat = new GpsyChat();
        const readingsManager = new ReadingsManager();
        const analyticsNotifier = new AnalyticsNotifier();
        
        // Expose globally for inline handlers
        window.session = session;
        window.timer = timer;
        window.gpsyChat = gpsyChat;
        window.settings = settings;
        window.readingsManager = readingsManager;
        window.analyticsNotifier = analyticsNotifier;
        
        // Expose utility functions for modules
        window.vibrate = Utils.vibrate;
        window.showSnackbar = Utils.showSnackbar;
        window.showToast = Utils.showToast;
        window.isDevelopmentMode = Utils.isDevelopmentMode;
        window.normalizeDate = Utils.normalizeDate;
        window.showSheet = Utils.showSheet;
        window.hideSheet = Utils.hideSheet;
    </script>
</body>
</html>


