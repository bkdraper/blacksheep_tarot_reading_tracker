<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tarot Reading Tracker" id="appleTitle">
    <meta name="application-name" content="Tarot Reading Tracker" id="appName">
    <meta name="msapplication-starturl" content="/">
    <link rel="icon" type="image/png" id="favicon" href="/logo192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <title>Tarot Reading Tracker</title>

    <script>
        // Global app title variable
        function isDevelopmentMode() {
            return window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.hostname.startsWith('192.168.') ||
                   window.location.hostname.startsWith('10.') ||
                   window.location.port === '8080' ||
                   window.location.protocol === 'file:' ||
                   window.location.search.includes('dev=true');
        }
        window.APP_TITLE = isDevelopmentMode() ? '[DEV] Tarot Reading Tracker' : 'Tarot Reading Tracker';
        window.APP_LOGO = isDevelopmentMode() ? '/logo192-dev.png' : '/logo192.png';
        document.title = window.APP_TITLE;
        document.getElementById('favicon').href = window.APP_LOGO;
        document.getElementById('appleTitle').content = window.APP_TITLE;
        document.getElementById('appName').content = window.APP_TITLE;
        // Set header title after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            const headerTitle = document.getElementById('headerTitle');
            if (headerTitle) headerTitle.textContent = window.APP_TITLE;
        });
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            margin: 0;
        }
        .header {
            background: #28a745;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background 0.2s;
        }
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px 15px;
        }
        .input-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        label { 
            font-weight: bold; 
            white-space: nowrap;
            min-width: 70px;
            text-align: right;
        }
        input[type="number"] { 
            width: 100px; 
            padding: 8px; 
            font-size: 16px; 
            border: 2px solid #ccc; 
            border-radius: 6px;
            text-align: center;
            -webkit-appearance: none;
            appearance: none;
        }
        .price-input-container {
            position: relative;
            flex: 1;
            min-width: 0;
        }
        .price-input-container input {
            padding-left: 30px;
        }
        .dollar-sign {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
            color: #666;
            z-index: 1;
        }
        input[type="text"], input[type="date"], select {
            flex: 1;
            min-width: 0;
            padding: 8px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 6px;
            -webkit-appearance: none;
            appearance: none;
            box-sizing: border-box;
        }
        .day-toggles {
            display: flex;
            gap: 8px;
            flex: 1;
        }
        .day-btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
        }
        .day-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .btn-new-session {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            flex: 1;
            touch-action: manipulation;
        }
        .btn-load-session {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 8px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            flex: 1;
            touch-action: manipulation;
        }
        .btn-load-session.disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .session-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .session-item:hover {
            background-color: #f8f9fa;
        }
        .session-info {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .session-details {
            font-size: 14px;
            color: #666;
        }
        .event-settings {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .settings-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }
        .settings-content {
            padding: 15px;
            display: none;
            overflow: hidden;
        }
        .settings-content.open {
            display: block;
        }
        .collapse-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        .collapse-icon.open {
            transform: rotate(180deg);
        }
        .user-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .user-section label::before {
            content: '\f2bd';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 5px;
        }
        .user-section .btn-load-session {
            width: 100%;
            margin-top: 10px;
        }
        .buttons { 
            display: flex; 
            gap: 10px; 
            margin: 20px 0; 
        }
        .btn-create-session {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            flex: 1;
            touch-action: manipulation;
        }
        .btn-create-session.inactive {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .required-field {
            border: 2px solid #dc3545 !important;
        }
        .required-group {
            border: 2px solid #dc3545;
            border-radius: 6px;
            padding: 8px;
        }
        .btn-add { 
            flex: 3; 
            background: #28a745; 
            color: white; 
            border: none; 
            padding: 18px; 
            font-size: 18px; 
            border-radius: 8px; 
            cursor: pointer;
            min-height: 60px;
            touch-action: manipulation;
        }
        .btn-remove { 
            flex: 1; 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 18px; 
            font-size: 18px; 
            border-radius: 8px; 
            cursor: pointer;
            min-height: 60px;
            touch-action: manipulation;
        }
        .totals { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .totals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .totals-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }
        .totals-table td:first-child {
            color: #666;
        }
        .totals-table td:last-child {
            text-align: right;
            font-weight: 500;
        }
        .grand-total {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            padding-top: 8px;
            border-top: 2px solid #28a745;
        }
        .readings-list { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .reading-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 15px;
            padding: 15px 0; 
            border-bottom: 2px solid #ddd; 
            min-height: 50px;
        }
        .reading-item:last-child { 
            border-bottom: none; 
        }
        .reading-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        .reading-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reading-field {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .field-label {
            font-size: 12px;
            color: #666;
            min-width: 45px;
            font-weight: 500;
        }
        .index { font-size: 14px; color: #999; font-weight: bold; }
        .timestamp { font-size: 15px; color: #666; }
        .tip-input { 
            width: 80px !important; 
            padding: 8px 6px 8px 25px !important; 
            font-size: 14px !important; 
            border: 2px solid #ccc !important; 
            background-color: white !important;
            border-radius: 6px !important;
            text-align: center !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            box-sizing: border-box !important;
            min-height: 36px !important;
        }
        .price-input {
            width: 80px !important;
            padding: 8px 6px 8px 25px !important;
            font-size: 14px !important;
            border: 2px solid #ccc !important;
            background-color: white !important;
            border-radius: 6px !important;
            text-align: center !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            box-sizing: border-box !important;
            min-height: 36px !important;
        }
        .field-input-container {
            position: relative;
            flex: 1;
        }
        .field-input-container .dollar-sign {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
            z-index: 1;
        }
        .field-button {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 36px;
            touch-action: manipulation;
        }
        .field-button.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            min-height: 44px !important;
            min-width: 40px !important;
        }
        .payment-method-btn {
            padding: 8px 12px;
            font-size: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
            flex: 1;
        }
        .payment-method-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .source-btn {
            padding: 8px 12px;
            font-size: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
            flex: 1;
        }
        .source-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .payment-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 2001;
            animation: slideUpSheet 0.3s ease;
        }
        .payment-sheet-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-sheet-options {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .payment-option {
            padding: 16px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .payment-option:hover {
            background: #f8f9fa;
        }
        .payment-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .session-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 2001;
            animation: slideUpSheet 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }
        .session-sheet-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .session-sheet-content {
            padding: 20px;
        }
        .user-btn {
            flex: 2;
            min-width: 0;
            padding: 8px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: left;
            -webkit-appearance: none;
            appearance: none;
            box-sizing: border-box;
            min-height: 44px;
            touch-action: manipulation;
        }
        .user-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .user-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            font-size: 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-item:hover {
            background-color: #f8f9fa;
        }
        .btn-add-user {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            min-height: 44px;
            margin-top: 10px;
            touch-action: manipulation;
        }
        .timer {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .timer-canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        .timer-canvas {
            border: none;
            padding: 0;
            margin: 0;
        }
        .timer h3 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .timer-display {
            font-size: 80px;
            font-weight: bold;
            font-family: monospace;
            margin: 30px 0;
            color: #333;
        }
        .timer-display.blink {
            animation: blink 1s infinite;
        }
        .timer-display.warning {
            animation: warning-blink 0.5s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; color: #dc3545; }
            51%, 100% { opacity: 0.3; color: #dc3545; }
        }
        @keyframes warning-blink {
            0%, 50% { color: #333; }
            51%, 100% { color: #999; }
        }
        .timer-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .timer-input {
            width: 80px;
            padding: 8px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 6px;
            text-align: center;
            -webkit-appearance: none;
            appearance: none;
        }
        .arrow-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            min-width: 44px;
        }
        .timer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .timer-btn {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
        }
        .start-btn { 
            background: #28a745; 
            color: white; 
            flex: 3;
            padding: 24px 32px;
            font-size: 22px;
            font-weight: bold;
            min-height: 70px;
        }
        .pause-btn { background: #ffc107; color: black; }
        .reset-btn { background: #dc3545; color: white; }

        .settings-drawer {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        .settings-drawer.open {
            right: 0;
        }
        .settings-drawer-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        .settings-drawer-content {
            padding: 20px;
        }
        .settings-section {
            margin-bottom: 30px;
        }
        .settings-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-size: 14px;
            color: #333;
        }
        .setting-description {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #28a745;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        .toggle-switch.active::after {
            left: 28px;
        }
        .settings-select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
            flex: none;
        }
        .settings-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            min-height: 36px;
        }
        .settings-button.danger {
            background: #dc3545;
        }
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        .settings-overlay.open {
            display: block;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            min-width: 200px;
            max-width: 90vw;
        }
        .snackbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px 20px;
            font-size: 14px;
            text-align: center;
            z-index: 3000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }
        .snackbar.success {
            background: #d4edda;
            color: #155724;
        }
        .snackbar.error {
            background: #f8d7da;
            color: #721c24;
        }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideUpSheet {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        .spinner.inline {
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            margin: 0 8px 0 0;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Payment Methods Customization Sheet */
        .payment-methods-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 2001;
            animation: slideUpSheet 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }
        .payment-method-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 10px;
        }
        .payment-method-item:last-child {
            border-bottom: none;
        }
        .payment-method-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }
        .payment-method-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            min-height: 36px;
        }
        .add-payment-method {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            min-height: 44px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
            color: #ffffff;
        }
        body.dark-mode .container {
            background: #1a1a1a;
        }
        body.dark-mode .event-settings,
        body.dark-mode .totals,
        body.dark-mode .readings-list,
        body.dark-mode .timer {
            background: #2d2d2d;
            color: #ffffff;
        }
        body.dark-mode .settings-header,
        body.dark-mode h3,
        body.dark-mode label {
            color: #ffffff;
        }
        body.dark-mode .timestamp,
        body.dark-mode .session-details {
            color: #cccccc;
        }
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode .user-btn {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }
        body.dark-mode .day-btn {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }
        body.dark-mode .settings-drawer {
            background: #2d2d2d;
            color: #ffffff;
        }
        body.dark-mode .settings-drawer-header {
            background: #1a1a1a;
            border-color: #555;
        }
        body.dark-mode .setting-item {
            border-color: #555;
        }
        body.dark-mode .setting-label {
            color: #ffffff;
        }
        body.dark-mode .setting-description {
            color: #cccccc;
        }
        body.dark-mode .modal-content,
        body.dark-mode .payment-methods-sheet {
            background: #2d2d2d;
            color: #ffffff;
        }
        body.dark-mode .payment-method-input {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }
        body.dark-mode .session-sheet,
        body.dark-mode .payment-sheet {
            background: #2d2d2d;
            color: #ffffff;
        }
        body.dark-mode .session-info {
            color: #ffffff;
        }
        body.dark-mode .header {
            background: #1a4d2e;
        }
        body.dark-mode .dollar-sign {
            background: #555;
            color: #cccccc;
        }
        body.dark-mode .timer-display {
            color: #f4e4a6 !important;
        }
        
        .btn {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
        }
        .btn-secondary {
            background: #007bff;
            color: white;
        }
        .btn-secondary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* ========================================
           GPSY CHAT STYLES
           ======================================== */
        .gpsy-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100dvh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 3000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .gpsy-drawer.open {
            right: 0;
        }
        .gpsy-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #28a745;
            color: white;
            flex-shrink: 0;
        }
        .gpsy-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .gpsy-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }
        .gpsy-message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .gpsy-message.user {
            flex-direction: row-reverse;
        }
        .gpsy-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .gpsy-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            animation: gpsyPulse 2s ease-in-out infinite;
        }
        .gpsy-avatar.thinking img {
            animation: gpsyBounce 0.6s ease-in-out infinite;
        }
        @keyframes gpsyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes gpsyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .gpsy-message.user .gpsy-avatar {
            background: #007bff;
        }
        .gpsy-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            background: #f0f0f0;
            word-wrap: break-word;
        }
        .gpsy-message.user .gpsy-bubble {
            background: #007bff;
            color: white;
        }
        .gpsy-input-container {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .gpsy-input-container input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 24px;
            font-size: 16px;
        }
        .gpsy-send-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            min-height: 44px;
        }
        .tracker-buddy-btn {
            width: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 60px;
        }
        .tracker-buddy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        .gpsy-thinking {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }
        .gpsy-thinking span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: thinking 1.4s infinite;
        }
        .gpsy-thinking span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .gpsy-thinking span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes thinking {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Dark mode for Gpsy */
        body.dark-mode .gpsy-drawer {
            background: #2d2d2d;
            color: #ffffff;
        }
        body.dark-mode .gpsy-header {
            background: #1a4d2e;
        }
        body.dark-mode .gpsy-bubble {
            background: #3d3d3d;
            color: #ffffff;
        }
        
        /* Bedrock suggestion buttons */
        .bedrock-suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        .bedrock-suggestion {
            background: #f8f9fa;
            border: 2px solid #7c3aed;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }
        .bedrock-suggestion:hover {
            background: #ede9fe;
            border-color: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        .bedrock-suggestion:active {
            transform: translateY(0);
        }
        
        body.dark-mode .bedrock-suggestions {
            border-top-color: #555;
        }
        body.dark-mode .bedrock-suggestion {
            background: #3d3d3d;
            border-color: #a78bfa;
            color: #ffffff;
        }
        body.dark-mode .bedrock-suggestion:hover {
            background: #4d4d4d;
            border-color: #c4b5fd;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.3);
        }
        
        /* Gpsy quick actions */
        .gpsy-quick-actions {
            padding: 10px 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .gpsy-quick-action {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
            min-height: 36px;
        }
        .gpsy-quick-action:hover {
            background: #218838;
        }
        .gpsy-empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }
        .gpsy-empty-state h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #333;
        }
        .gpsy-example-query {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
        }
        .gpsy-example-query:hover {
            background: #e9ecef;
        }
        .gpsy-example-query strong {
            display: block;
            margin-bottom: 4px;
            color: #28a745;
        }
        
        body.dark-mode .gpsy-quick-actions {
            border-top-color: #555;
        }
        body.dark-mode .gpsy-empty-state {
            color: #aaa;
        }
        body.dark-mode .gpsy-empty-state h3 {
            color: #ffffff;
        }
        body.dark-mode .gpsy-example-query {
            background: #3d3d3d;
            border-color: #555;
            color: #ffffff;
        }
        body.dark-mode .gpsy-example-query:hover {
            background: #4d4d4d;
        }
        
        /* Bedrock response styling */
        .bedrock-response {
            margin: 10px 0;
        }
        .bedrock-section {
            font-size: 17px;
            font-weight: bold;
            margin: 12px 0 10px 0;
            color: #111;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
        }
        .bedrock-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 10px 0;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .bedrock-header {
            background: #e0e0e0;
            font-weight: bold;
            padding: 10px 8px;
            text-align: left;
            border-bottom: 2px solid #ccc;
            border-right: 1px solid #ddd;
            font-size: 15px;
            color: #222;
        }
        .bedrock-header:last-child {
            border-right: none;
        }
        .bedrock-cell {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
            text-align: left;
            background: white;
        }
        .bedrock-cell:last-child {
            border-right: none;
        }
        .bedrock-table tr:last-child .bedrock-cell {
            border-bottom: none;
        }
        .bedrock-currency {
            font-weight: 500;
            color: #28a745;
        }
        .bedrock-total {
            font-weight: bold;
            font-size: 16px;
        }
        .bedrock-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        .bedrock-item {
            margin: 5px 0;
        }
        .bedrock-highlight {
            font-weight: bold;
            color: #007bff;
        }
        .bedrock-insight {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .bedrock-footnote {
            display: block;
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }
        
        /* Legacy table support */
        .gpsy-bubble table:not(.bedrock-table) {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 10px 0;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .gpsy-bubble th:not(.bedrock-header),
        .gpsy-bubble td:not(.bedrock-cell) {
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .gpsy-bubble th:last-child:not(.bedrock-header),
        .gpsy-bubble td:last-child:not(.bedrock-cell) {
            border-right: none;
        }
        .gpsy-bubble tr:last-child td:not(.bedrock-cell) {
            border-bottom: none;
        }
        .gpsy-bubble th:not(.bedrock-header) {
            font-weight: bold;
        }
        
        /* Dark mode */
        body.dark-mode .bedrock-section {
            color: #ffffff;
        }
        body.dark-mode .bedrock-table {
            border-color: #555;
        }
        body.dark-mode .bedrock-header {
            background: #4a4a4a;
            border-color: #666;
            color: #ffffff;
            font-size: 15px;
        }
        body.dark-mode .bedrock-cell {
            border-color: #555;
            color: #ffffff;
            background: #2d2d2d;
        }
        body.dark-mode .bedrock-insight {
            background: #3d3d3d;
            border-color: #007bff;
            color: #ffffff;
        }
        body.dark-mode .bedrock-footnote {
            color: #aaa;
            border-top-color: #555;
        }
        body.dark-mode .gpsy-bubble table:not(.bedrock-table) {
            border-color: #555;
        }
        body.dark-mode .gpsy-bubble td:not(.bedrock-cell),
        body.dark-mode .gpsy-bubble th:not(.bedrock-header) {
            border-color: #555;
        }
        body.dark-mode .gpsy-message.user .gpsy-bubble {
            background: #0056b3;
        }
        body.dark-mode .gpsy-input-container input {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 id="headerTitle">Tarot Reading Tracker</h1>
        <div class="header-actions">
            <span class="version-badge">v3.96.0</span>
            <button class="settings-btn" onclick="openSettingsDrawer()" title="Settings"><i class="fas fa-cog"></i></button>
        </div>
    </header>
    <div class="container">
        <div class="event-settings">
            <div class="settings-header" onclick="toggleSettings()">
                <span>Event Settings</span>
                <span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="user-section">
                    <div class="input-group">
                        <label for="user">User:</label>
                        <button id="userBtn" onclick="showUserSelection()" class="user-btn">Select User...</button>
                    </div>
                    <button class="btn-load-session" onclick="showLoadSession()">Load Session</button>
                </div>

                <hr style="border: none; border-top: 1px solid #ddd; margin: 15px 0;">

                <div class="input-group">
                    <label for="price">Reading<br>Price:</label>
                    <div class="price-input-container">
                        <span class="dollar-sign">$</span>
                        <input type="number" id="price" value="40" step="0.01" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label for="location">Event<br>Name:</label>
                    <input type="text" id="location" placeholder="(City, Season, Year, etc.)">
                </div>

                <div class="input-group">
                    <label for="sessionDate">Event<br>Date:</label>
                    <input type="date" id="sessionDate" placeholder="Select event date" onclick="this.showPicker()">
                </div>

                <hr style="border: none; border-top: 1px solid #ddd; margin: 15px 0;">

                <div id="requiredFieldsNote" style="font-size: 11px; color: #dc3545; text-align: center; margin-bottom: 10px;">* Fill in the red-outlined fields to create a new session</div>

                <div class="input-group">
                    <button class="btn-create-session inactive" onclick="handleCreateSession()">Create Session</button>
                    <button class="btn-new-session" onclick="startNewSession()" style="display: none;">New Session</button>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-add" onclick="addReading()">+ Add Reading</button>
            <button class="btn-remove" onclick="removeReading()">-</button>
        </div>

        <div class="totals">
            <table class="totals-table">
                <tr>
                    <td><i class="fas fa-book-open" style="margin-right: 8px;"></i>Readings:</td>
                    <td><span id="readingCount">0</span></td>
                </tr>
                <tr>
                    <td><i class="fas fa-coins" style="margin-right: 8px;"></i>Base Total:</td>
                    <td>$<span id="baseTotal">0.00</span></td>
                </tr>
                <tr>
                    <td><i class="fas fa-hand-holding-usd" style="margin-right: 8px;"></i>Tips Total:</td>
                    <td>$<span id="tipsTotal">0.00</span></td>
                </tr>
            </table>
            <div class="grand-total"><i class="fas fa-wallet" style="margin-right: 8px;"></i>Total: $<span id="grandTotal">0.00</span></div>
        </div>

        <div class="readings-list">
            <h3>Readings Log</h3>
            <div id="readingsList"></div>
        </div>

        <div class="timer">
            <h3>Timer</h3>
            <div class="timer-controls">
                <button class="arrow-btn" onclick="adjustTime(-1)"><i class="fas fa-minus"></i></button>
                <input type="number" class="timer-input" id="timerInput" value="15" min="0" max="99" inputmode="numeric">
                <button class="arrow-btn" onclick="adjustTime(1)"><i class="fas fa-plus"></i></button>
            </div>
            <div class="timer-canvas-container">
                <canvas id="timerCanvas" class="timer-canvas" width="300" height="300"></canvas>
            </div>
            <div class="timer-display" id="timerDisplay" style="display: none;">15:00</div>
            <div class="timer-buttons">
                <button class="timer-btn start-btn" onclick="startTimer()">Start</button>
                <button class="timer-btn pause-btn" onclick="pauseTimer()">Pause</button>
                <button class="timer-btn reset-btn" onclick="resetTimer()">Reset</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Sheet -->
    <div id="paymentOverlay" class="payment-overlay" onclick="closePaymentSheet()"></div>
    <div id="paymentSheet" class="payment-sheet">
        <div class="payment-sheet-header">
            <h3>Select Payment Method</h3>
            <button class="modal-close" onclick="closePaymentSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="payment-sheet-options" id="paymentOptions">
            <!-- Payment options populated dynamically -->
        </div>
    </div>

    <!-- Source Sheet -->
    <div id="sourceOverlay" class="payment-overlay" onclick="closeSourceSheet()"></div>
    <div id="sourceSheet" class="payment-sheet">
        <div class="payment-sheet-header">
            <h3>Select Source</h3>
            <button class="modal-close" onclick="closeSourceSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="payment-sheet-options" id="sourceOptions">
            <!-- Source options populated dynamically -->
        </div>
    </div>

    <!-- User Selection Sheet -->
    <div id="userOverlay" class="payment-overlay" onclick="hideUserSelection()"></div>
    <div id="userSheet" class="session-sheet">
        <div class="session-sheet-header">
            <h3>Select User</h3>
            <button class="modal-close" onclick="hideUserSelection()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="userList"></div>
            <button onclick="addNewUser()" class="btn-add-user">+ Add New User</button>
        </div>
    </div>

    <!-- Load Session Sheet -->
    <div id="sessionOverlay" class="payment-overlay" onclick="closeSessionSheet()"></div>
    <div id="sessionSheet" class="session-sheet">
        <div class="session-sheet-header">
            <h3>Load Existing Session</h3>
            <button class="modal-close" onclick="closeSessionSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="sessionsList"></div>
        </div>
    </div>

    <!-- Payment Methods Customization Sheet -->
    <div id="paymentMethodsOverlay" class="payment-overlay" onclick="closePaymentMethodsSheet()"></div>
    <div id="paymentMethodsSheet" class="payment-methods-sheet">
        <div class="session-sheet-header">
            <h3>Customize Payment Methods</h3>
            <button class="modal-close" onclick="closePaymentMethodsSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="paymentMethodsList"></div>
            <button onclick="addPaymentMethod()" class="add-payment-method">+ Add Payment Method</button>
        </div>
    </div>

    <!-- Sources Customization Sheet -->
    <div id="sourcesOverlay" class="payment-overlay" onclick="closeSourcesSheet()"></div>
    <div id="sourcesSheet" class="payment-methods-sheet">
        <div class="session-sheet-header">
            <h3>Customize Sources</h3>
            <button class="modal-close" onclick="closeSourcesSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="session-sheet-content">
            <div id="sourcesList"></div>
            <button onclick="addSource()" class="add-payment-method">+ Add Source</button>
        </div>
    </div>

    <!-- Gpsy Chat Drawer -->
    <div id="gpsyOverlay" class="settings-overlay" onclick="gpsyChat.close()"></div>
    <div id="gpsyDrawer" class="gpsy-drawer">
        <div class="gpsy-header">
            <h2 style="display: flex; align-items: center; gap: 10px;">
                <div class="gpsy-avatar" style="width: 28px; height: 28px; background: transparent;">
                    <img src="" id="gpsyHeaderLogo" alt="ChatGPSY">
                </div>
                ChatGPSY
            </h2>
            <button class="modal-close" onclick="gpsyChat.close()"><i class="fas fa-times"></i></button>
        </div>
        <div id="gpsyMessages" class="gpsy-messages"></div>
        <div id="gpsyQuickActions" class="gpsy-quick-actions" style="display: none;">
            <!-- Quick action chips populated dynamically -->
        </div>
        <div class="gpsy-input-container">
            <input type="text" id="gpsyInput" placeholder="Ask about your readings..." onkeydown="if(event.key==='Enter') gpsyChat.send()">
            <button id="gpsySendBtn" onclick="gpsyChat.send()" class="gpsy-send-btn">Send</button>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div id="settingsOverlay" class="settings-overlay" onclick="closeSettingsDrawer()"></div>
    <div id="settingsDrawer" class="settings-drawer">
        <div class="settings-drawer-header">
            <h2>Settings</h2>
            <button class="modal-close" onclick="closeSettingsDrawer()"><i class="fas fa-times"></i></button>
        </div>
        <div class="settings-drawer-content">
            <!-- ChatGPSY -->
            <div class="settings-section" style="border-bottom: 2px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
                <button class="tracker-buddy-btn" onclick="gpsyChat.open()">
                    <div class="gpsy-avatar" style="width: 32px; height: 32px; background: transparent;">
                        <img src="" id="buddyLogo" alt="ChatGPSY">
                    </div>
                    <span style="font-size: 16px; font-weight: 600;">ChatGPSY</span>
                </button>
            </div>

            <!-- App Preferences -->
            <div class="settings-section">
                <h3>App Preferences</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Sound Alerts</div>
                        <div class="setting-description">Timer alarm sounds</div>
                    </div>
                    <div class="toggle-switch" id="soundToggle" onclick="toggleSetting('sound')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Haptic Feedback</div>
                        <div class="setting-description">Vibration on button presses</div>
                    </div>
                    <div class="toggle-switch" id="hapticToggle" onclick="toggleSetting('haptic')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Timer Notifications</div>
                        <div class="setting-description">Push notifications when timer expires</div>
                    </div>
                    <div class="toggle-switch" id="timerNotificationsToggle" onclick="toggleSetting('timerNotifications')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Dark Mode</div>
                        <div class="setting-description">Dark theme for evening events</div>
                    </div>
                    <div class="toggle-switch" id="darkModeToggle" onclick="toggleSetting('darkMode')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Default Timer</div>
                        <div class="setting-description">Default timer duration</div>
                    </div>
                    <select class="settings-select" id="defaultTimer" onchange="updateSetting('defaultTimer', this.value)">
                        <option value="5">5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="15" selected>15 minutes</option>
                        <option value="20">20 minutes</option>
                        <option value="30">30 minutes</option>
                    </select>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="settings-section">
                <h3>Payment Methods</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Available Methods</div>
                        <div class="setting-description">Customize payment options</div>
                    </div>
                    <button class="settings-button" onclick="customizePaymentMethods()">Customize</button>
                </div>
            </div>

            <!-- Sources -->
            <div class="settings-section">
                <h3>Sources</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Available Sources</div>
                        <div class="setting-description">Customize source options</div>
                    </div>
                    <button class="settings-button" onclick="customizeSources()">Customize</button>
                </div>
            </div>

            <!-- Data & Export -->
            <div class="settings-section">
                <h3>Data & Export</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Export Data</div>
                        <div class="setting-description">Download session data as CSV</div>
                    </div>
                    <button class="settings-button" onclick="exportData()">Export</button>
                </div>
            </div>

            <!-- Analytics -->
            <div class="settings-section">
                <h3>Analytics & Notifications</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Daily Summary</div>
                        <div class="setting-description">End of day notifications</div>
                    </div>
                    <div class="toggle-switch" id="dailySummaryToggle" onclick="toggleSetting('dailySummary')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Weekend Goals</div>
                        <div class="setting-description">Earnings milestone alerts</div>
                    </div>
                    <div class="toggle-switch" id="weekendGoalsToggle" onclick="toggleSetting('weekendGoals')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Best Day Alerts</div>
                        <div class="setting-description">Peak performance notifications</div>
                    </div>
                    <div class="toggle-switch" id="bestDayToggle" onclick="toggleSetting('bestDay')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Tip Trends</div>
                        <div class="setting-description">Tip analysis notifications</div>
                    </div>
                    <div class="toggle-switch" id="tipTrendsToggle" onclick="toggleSetting('tipTrends')"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Peak Time Alerts</div>
                        <div class="setting-description">Busy time notifications</div>
                    </div>
                    <div class="toggle-switch" id="peakTimeToggle" onclick="toggleSetting('peakTime')"></div>
                </div>
            </div>

            <!-- App Updates -->
            <div class="settings-section">
                <h3>App Updates</h3>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Check for Updates</div>
                        <div class="setting-description">Manually check for new app versions</div>
                    </div>
                    <button class="settings-button" onclick="checkForUpdates()">Check</button>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Clear Cache</div>
                        <div class="setting-description">Clear all cached files and reload</div>
                    </div>
                    <button class="settings-button" onclick="clearCache()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2?v=2"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1691.0.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://uuindvqgdblkjzvjsyrz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_MsdJm2VITIPWik4dBPErrw_QjfIsKe9';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Service worker registration for PWA with message handling
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/serviceWorker.js')
                .then(registration => {
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                    // Register for periodic background sync (requires user permission)
                    if ('periodicSync' in window.ServiceWorkerRegistration.prototype) {
                        registration.periodicSync.register('backup-readings', {
                            minInterval: 24 * 60 * 60 * 1000 // 24 hours
                        }).catch(() => {});
                    }
                    
                    // Request notification permission
                    if ('Notification' in window && 'serviceWorker' in navigator) {
                        Notification.requestPermission();
                    }
                })
                .catch(() => {});
            
            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SYNC_READINGS') {
                    handleBackgroundSync();
                } else if (event.data.type === 'BACKUP_READINGS') {
                    handleBackgroundBackup();
                } else if (event.data.type === 'RESET_TIMER') {
                    handleTimerReset();
                }
            });
            
            // Handle timer reset from notification
            function handleTimerReset() {
                timer.reset(true);
            }
        }

        
        // Central Session Store
        // SESSION STORE CLASS - See session-store.js
        class Timer {
            constructor() {
                this._seconds = 900; // 15 minutes default
                this._totalSeconds = 900;
                this._isRunning = false;
                this._isBlinking = false;
                this._interval = null;
                this._alarmInterval = null;
                this._canvasAnimationId = null;
                this._wakeLock = null;
                this._silentAudio = null;
                this._canvas = null;
                this._ctx = null;
            }

            // Getters
            get seconds() { return this._seconds; }
            get totalSeconds() { return this._totalSeconds; }
            get isRunning() { return this._isRunning; }
            get isBlinking() { return this._isBlinking; }
            get canvas() { return this._canvas; }
            get ctx() { return this._ctx; }

            // Setters
            set seconds(value) {
                this._seconds = value;
                this.updateDisplay();
            }

            // Methods
            start() {
                vibrate([80]);
                if (!this._isRunning && this._seconds > 0) {
                    this._isRunning = true;
                    this._totalSeconds = this._seconds;
                    this.stopBlinking();
                    this.requestWakeLock();
                    
                    if (this._canvas) {
                        this.drawTimer();
                    }
                    
                    this._interval = setInterval(() => {
                        this._seconds--;
                        this.updateDisplay();
                        
                        if (this._seconds === 10) {
                            this.startWarningBlink();
                        }
                        
                        if (this._seconds <= 0) {
                            this.pause();
                            this.stopWarningBlink();
                            this.startBlinking();
                            this.startAlarm();
                            sendTimerNotification();
                        }
                    }, 1000);
                }
            }

            pause() {
                vibrate([50]);
                this._isRunning = false;
                this.releaseWakeLock();
                
                if (this._canvasAnimationId) {
                    cancelAnimationFrame(this._canvasAnimationId);
                    this._canvasAnimationId = null;
                }
                
                if (this._interval) {
                    clearInterval(this._interval);
                    this._interval = null;
                }
            }

            reset(showToast = false) {
                vibrate([100]);
                this.pause();
                this.stopBlinking();
                this.stopWarningBlink();
                this.stopAlarm();
                this.releaseWakeLock();
                const minutes = parseInt(document.getElementById('timerInput').value);
                this._seconds = minutes * 60;
                this._totalSeconds = this._seconds;
                this.updateDisplay();
                
                if (showToast) {
                    showSnackbar(`Timer reset to ${minutes} minutes`, 'success');
                }
            }

            adjustTime(minutes) {
                vibrate([30]);
                if (!this._isRunning) {
                    const input = document.getElementById('timerInput');
                    let newValue = parseInt(input.value) + minutes;
                    if (newValue < 0) newValue = 0;
                    if (newValue > 99) newValue = 99;
                    input.value = newValue;
                    this._seconds = newValue * 60;
                    this.updateDisplay();
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this._seconds / 60);
                const seconds = this._seconds % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (this._canvas) {
                    this.drawTimer();
                }
            }

            startBlinking() {
                this._isBlinking = true;
                document.getElementById('timerDisplay').classList.add('blink');
            }

            stopBlinking() {
                this._isBlinking = false;
                document.getElementById('timerDisplay').classList.remove('blink');
            }

            startWarningBlink() {
                document.getElementById('timerDisplay').classList.add('warning');
            }

            stopWarningBlink() {
                document.getElementById('timerDisplay').classList.remove('warning');
            }

            startAlarm() {
                playAlarmSequence();
                this._alarmInterval = setInterval(() => {
                    playAlarmSequence();
                }, 1500);
            }

            stopAlarm() {
                if (this._alarmInterval) {
                    clearInterval(this._alarmInterval);
                    this._alarmInterval = null;
                }
            }

            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this._wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {}
                
                try {
                    initAudio();
                    const buffer = audioContext.createBuffer(1, 1, 22050);
                    this._silentAudio = audioContext.createBufferSource();
                    this._silentAudio.buffer = buffer;
                    this._silentAudio.loop = true;
                    const gainNode = audioContext.createGain();
                    this._silentAudio.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
                    this._silentAudio.start();
                } catch (audioErr) {}
            }

            releaseWakeLock() {
                if (this._wakeLock) {
                    this._wakeLock.release();
                    this._wakeLock = null;
                }
                if (this._silentAudio) {
                    this._silentAudio.stop();
                    this._silentAudio = null;
                }
            }

            initCanvas() {
                this._canvas = document.getElementById('timerCanvas');
                this._ctx = this._canvas.getContext('2d');
                this._ctx.imageSmoothingEnabled = false;
                this.drawTimer();
            }

            drawTimer() {
                if (!this._ctx) return;
                
                const centerX = 150;
                const centerY = 150;
                const radius = 120;
                
                this._ctx.clearRect(0, 0, 300, 300);
                
                // Background circle
                this._ctx.beginPath();
                this._ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                this._ctx.strokeStyle = '#e0e0e0';
                this._ctx.lineWidth = 12;
                this._ctx.stroke();
                
                // Progress arc
                if (this._isRunning) {
                    const progress = this._seconds / this._totalSeconds;
                    if (progress > 0) {
                        this._ctx.beginPath();
                        this._ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + (2 * Math.PI * progress));
                        
                        const red = Math.round(220 * (1 - progress) + 40 * progress);
                        const green = Math.round(167 * progress + 53 * (1 - progress));
                        const blue = Math.round(69 * (1 - progress));
                        this._ctx.strokeStyle = `rgb(${red}, ${green}, ${blue})`;
                        
                        this._ctx.lineWidth = 12;
                        this._ctx.lineCap = 'round';
                        this._ctx.stroke();
                    }
                } else {
                    this._ctx.beginPath();
                    this._ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    this._ctx.strokeStyle = '#28a745';
                    this._ctx.lineWidth = 12;
                    this._ctx.stroke();
                }
                
                // Time text
                const minutes = Math.floor(this._seconds / 60);
                const seconds = this._seconds % 60;
                const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (this._isRunning) {
                    const progress = this._seconds / this._totalSeconds;
                    const red = Math.round(51 * (1 - progress) + 220 * (1 - progress));
                    const green = Math.round(51 * progress + 53 * (1 - progress));
                    const blue = Math.round(51 * (1 - progress));
                    this._ctx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
                } else {
                    this._ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#f4e4a6' : '#333';
                }
                this._ctx.font = 'bold 72px monospace';
                this._ctx.textAlign = 'center';
                this._ctx.textBaseline = 'middle';
                this._ctx.fillText(timeText, centerX, centerY);
                
                if (this._isRunning) {
                    this._canvasAnimationId = requestAnimationFrame(() => this.drawTimer());
                }
            }
        }

        // Settings Store
        class SettingsStore {
            constructor() {
                this.defaults = {
                    sound: true,
                    haptic: true,
                    darkMode: false,
                    defaultTimer: 15,
                    timerNotifications: true,
                    dailySummary: true,
                    weekendGoals: true,
                    bestDay: true,
                    tipTrends: true,
                    peakTime: true,
                    paymentMethods: ['Cash', 'CC', 'Venmo', 'PayPal', 'Cash App'],
                    sources: ['Referral', 'Renu', 'POG', 'Repeat']
                };
                this.settings = this.loadSettings();
                this.applySettings();
            }

            loadSettings() {
                const saved = localStorage.getItem('tarotTrackerSettings');
                return saved ? { ...this.defaults, ...JSON.parse(saved) } : { ...this.defaults };
            }

            saveSettings() {
                localStorage.setItem('tarotTrackerSettings', JSON.stringify(this.settings));
            }

            get(key) {
                return this.settings[key];
            }

            set(key, value) {
                this.settings[key] = value;
                this.saveSettings();
                this.applySettings();
            }

            toggle(key) {
                this.set(key, !this.get(key));
            }

            applySettings() {
                // Apply dark mode
                if (this.get('darkMode')) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }

                // Redraw timer canvas for color changes
                if (window.timer && window.timer.canvas) {
                    window.timer.drawTimer();
                }

                // Update UI toggles
                this.updateToggleUI();
            }

            updateToggleUI() {
                const toggles = {
                    'soundToggle': 'sound',
                    'hapticToggle': 'haptic',
                    'darkModeToggle': 'darkMode',
                    'timerNotificationsToggle': 'timerNotifications',
                    'dailySummaryToggle': 'dailySummary',
                    'weekendGoalsToggle': 'weekendGoals',
                    'bestDayToggle': 'bestDay',
                    'tipTrendsToggle': 'tipTrends',
                    'peakTimeToggle': 'peakTime'
                };

                Object.entries(toggles).forEach(([elementId, settingKey]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.classList.toggle('active', this.get(settingKey));
                    }
                });

                // Update default timer select
                const timerSelect = document.getElementById('defaultTimer');
                if (timerSelect) {
                    timerSelect.value = this.get('defaultTimer');
                }
            }
        }

        // Date normalization utility
        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            // Convert YYYY-MM-DD or YY-MM-DD to MM/DD/YYYY
            if (dateStr.match(/^\d{2,4}-\d{2}-\d{2}$/)) {
                let [year, month, day] = dateStr.split('-');
                if (year.length === 2) year = '20' + year;
                return `${parseInt(month)}/${parseInt(day)}/${year}`;
            }
            return dateStr; // Already in MM/DD/YYYY or other format
        }

        // Initialize stores
        // SESSION STORE CLASS - See session-store.js
        
        // Analytics & Notification System
        class AnalyticsNotifier {
            constructor() {
                this.lastNotificationCheck = localStorage.getItem('lastNotificationCheck') || null;
            }
            
            async checkAndSendNotifications() {
                const today = new Date().toDateString();
                if (this.lastNotificationCheck === today) return;
                
                const sessions = await this.getRecentSessions();
                if (!sessions.length) return;
                
                // Daily summary (only if activity today)
                this.checkDailySummary(sessions, today);
                
                // Weekend goals (only on weekends with activity)
                this.checkWeekendGoals(sessions);
                
                // Best day alert (weekly check)
                this.checkBestDay(sessions);
                
                // Tip trends (weekly check)
                this.checkTipTrends(sessions);
                
                // Peak time alerts (after 3+ sessions)
                this.checkPeakTimes(sessions);
                
                this.lastNotificationCheck = today;
                localStorage.setItem('lastNotificationCheck', today);
            }
            
            async getRecentSessions() {
                try {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const { data } = await supabaseClient
                        .from('blacksheep_reading_tracker_sessions')
                        .select('*')
                        .gte('session_date', thirtyDaysAgo.toISOString().split('T')[0])
                        .order('session_date', { ascending: false });
                    
                    return data || [];
                } catch (error) {
                    return [];
                }
            }
            
            checkDailySummary(sessions, today) {
                if (!settings.get('dailySummary')) return;
                
                const todaySessions = sessions.filter(s => 
                    new Date(s.session_date).toDateString() === today && 
                    s.readings && s.readings.length > 0
                );
                
                if (todaySessions.length === 0) return;
                
                const totalReadings = todaySessions.reduce((sum, s) => sum + (s.readings?.length || 0), 0);
                const totalEarnings = todaySessions.reduce((sum, s) => {
                    const baseTotal = (s.readings?.length || 0) * (s.reading_price || 40);
                    const tipsTotal = s.readings?.reduce((tipSum, r) => tipSum + (r.tip || 0), 0) || 0;
                    return sum + baseTotal + tipsTotal;
                }, 0);
                
                if (totalReadings > 0) {
                    this.sendNotification(
                        '<i class="fas fa-chart-bar"></i> Daily Summary',
                        `Today: ${totalReadings} readings, $${totalEarnings.toFixed(2)} earned!`
                    );
                }
            }
            
            checkWeekendGoals(sessions) {
                if (!settings.get('weekendGoals')) return;
                
                const today = new Date();
                const isWeekend = today.getDay() === 0 || today.getDay() === 6; // Sunday or Saturday
                if (!isWeekend) return;
                
                const weekendSessions = sessions.filter(s => {
                    const sessionDate = new Date(s.session_date);
                    const dayOfWeek = sessionDate.getDay();
                    return (dayOfWeek === 0 || dayOfWeek === 6) && s.readings && s.readings.length > 0;
                });
                
                if (weekendSessions.length === 0) return;
                
                const currentWeekend = weekendSessions.filter(s => {
                    const sessionDate = new Date(s.session_date);
                    const startOfWeekend = new Date(today);
                    startOfWeekend.setDate(today.getDate() - (today.getDay() === 0 ? 1 : today.getDay() - 6));
                    return sessionDate >= startOfWeekend;
                });
                
                const totalReadings = currentWeekend.reduce((sum, s) => sum + (s.readings?.length || 0), 0);
                const totalEarnings = currentWeekend.reduce((sum, s) => {
                    const baseTotal = (s.readings?.length || 0) * (s.reading_price || 40);
                    const tipsTotal = s.readings?.reduce((tipSum, r) => tipSum + (r.tip || 0), 0) || 0;
                    return sum + baseTotal + tipsTotal;
                }, 0);
                
                // Earnings goals
                if (totalEarnings >= 500 && totalEarnings < 1000) {
                    this.sendNotification('<i class="fas fa-bullseye"></i> Weekend Goal', `$${totalEarnings.toFixed(2)} earned! $${(1000 - totalEarnings).toFixed(2)} to reach $1000 goal!`);
                } else if (totalEarnings >= 1000) {
                    this.sendNotification('<i class="fas fa-bullseye"></i> Weekend Goal', `Amazing! $${totalEarnings.toFixed(2)} earned this weekend!`);
                }
                
                // Reading count goals
                if (totalReadings >= 10 && totalReadings < 15) {
                    this.sendNotification('<i class="fas fa-book"></i> Reading Goal', `${totalReadings} readings done! ${15 - totalReadings} more to reach 15!`);
                } else if (totalReadings >= 15) {
                    this.sendNotification('<i class="fas fa-book"></i> Reading Goal', `Fantastic! ${totalReadings} readings this weekend!`);
                }
            }
            
            checkBestDay(sessions) {
                if (!settings.get('bestDay')) return;
                
                const dayEarnings = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                sessions.forEach(s => {
                    if (!s.readings || s.readings.length === 0) return;
                    const dayOfWeek = new Date(s.session_date).getDay();
                    const baseTotal = s.readings.length * (s.reading_price || 40);
                    const tipsTotal = s.readings.reduce((sum, r) => sum + (r.tip || 0), 0);
                    dayEarnings[dayOfWeek].push(baseTotal + tipsTotal);
                });
                
                let bestDay = null;
                let bestAverage = 0;
                
                Object.keys(dayEarnings).forEach(day => {
                    const earnings = dayEarnings[day];
                    if (earnings.length >= 2) {
                        const average = earnings.reduce((sum, e) => sum + e, 0) / earnings.length;
                        if (average > bestAverage) {
                            bestAverage = average;
                            bestDay = parseInt(day);
                        }
                    }
                });
                
                if (bestDay !== null) {
                    this.sendNotification(
                        '<i class="fas fa-star"></i> Best Day Alert',
                        `${dayNames[bestDay]} is your highest earning day - $${bestAverage.toFixed(2)} average!`
                    );
                }
            }
            
            checkTipTrends(sessions) {
                if (!settings.get('tipTrends')) return;
                
                const recentSessions = sessions.slice(0, 10);
                const olderSessions = sessions.slice(10, 20);
                
                if (recentSessions.length < 3 || olderSessions.length < 3) return;
                
                const recentAvgTip = this.calculateAverageTip(recentSessions);
                const olderAvgTip = this.calculateAverageTip(olderSessions);
                
                if (olderAvgTip === 0) return;
                
                const change = ((recentAvgTip - olderAvgTip) / olderAvgTip) * 100;
                
                if (Math.abs(change) >= 15) {
                    const trend = change > 0 ? 'increased' : 'decreased';
                    
                    this.sendNotification(
                        '<i class="fas fa-chart-line"></i> Tip Trends',
                        `Your average tip ${trend} ${Math.abs(change).toFixed(1)}% recently!`
                    );
                }
            }
            
            checkPeakTimes(sessions) {
                if (!settings.get('peakTime')) return;
                
                const timeSlots = {};
                let totalReadings = 0;
                
                sessions.forEach(s => {
                    if (!s.readings) return;
                    s.readings.forEach(r => {
                        totalReadings++;
                        const hour = this.parseTimeToHour(r.timestamp);
                        if (hour !== null) {
                            timeSlots[hour] = (timeSlots[hour] || 0) + 1;
                        }
                    });
                });
                
                if (totalReadings < 20) return;
                
                const timeSlotKeys = Object.keys(timeSlots);
                if (timeSlotKeys.length === 0) return;
                
                const peakHour = timeSlotKeys.reduce((peak, hour) => 
                    timeSlots[hour] > (timeSlots[peak] || 0) ? hour : peak
                );
                
                const peakCount = timeSlots[peakHour];
                const peakPercentage = (peakCount / totalReadings) * 100;
                
                if (peakPercentage >= 20) {
                    const timeRange = `${peakHour}:00-${parseInt(peakHour) + 1}:00`;
                    this.sendNotification(
                        '<i class="fas fa-clock"></i> Peak Time Alert',
                        `${timeRange} is your busiest time - ${peakPercentage.toFixed(1)}% of readings!`
                    );
                }
            }
            
            calculateAverageTip(sessions) {
                let totalTips = 0;
                let totalReadings = 0;
                
                sessions.forEach(s => {
                    if (!s.readings) return;
                    s.readings.forEach(r => {
                        totalReadings++;
                        totalTips += r.tip || 0;
                    });
                });
                
                return totalReadings > 0 ? totalTips / totalReadings : 0;
            }
            
            parseTimeToHour(timestamp) {
                const match = timestamp.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return null;
                
                let hour = parseInt(match[1]);
                const period = match[3].toUpperCase();
                
                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;
                
                return hour;
            }
            
            sendNotification(title, body) {
                if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, {
                            body: body,
                            icon: window.APP_LOGO,
                            badge: window.APP_LOGO,
                            tag: 'analytics-notification',
                            vibrate: [100, 50, 100]
                        });
                    });
                }
            }
        }
        
        const analyticsNotifier = new AnalyticsNotifier();
        
        // Timer expiration notification
        function sendTimerNotification() {
            if (!settings.get('timerNotifications')) return;
            
            if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('<i class="fas fa-bell"></i> Timer Finished!', {
                        body: 'Your tarot reading timer has expired.',
                        icon: window.APP_LOGO,
                        badge: window.APP_LOGO,
                        tag: 'timer-expired',
                        requireInteraction: true,
                        vibrate: [200, 100, 200, 100, 200],
                        actions: [
                            {
                                action: 'reset-timer',
                                title: 'Reset Timer',
                                icon: window.APP_LOGO
                            }
                        ]
                    }).then(() => {
                        // Fallback for localhost - also try direct notification
                        if (isDevelopmentMode()) {
                            setTimeout(() => {
                                try {
                                    new Notification('<i class="fas fa-bell"></i> Timer Finished!', {
                                        body: 'Your tarot reading timer has expired.',
                                        icon: window.APP_LOGO
                                    });
                                } catch (err) {}
                            }, 100);
                        }
                    }).catch(() => {});
                }).catch(() => {});
            }
        }
        
        // Background sync handler
        async function handleBackgroundSync() {
            try {
                if (session.sessionId && session.readings.length > 0) {
                    await session.save();
                }
            } catch (error) {}
        }
        
        // Background backup handler
        async function handleBackgroundBackup() {
            try {
                // Create backup in localStorage with timestamp
                const backup = {
                    timestamp: new Date().toISOString(),
                    sessionData: {
                        sessionId: session.sessionId,
                        location: session.location,
                        selectedDay: session.selectedDay,
                        price: session.price,
                        readings: session.readings
                    }
                };
                localStorage.setItem('readingTracker_backup', JSON.stringify(backup));
            } catch (error) {}
        }
        
        // Register for background sync when going offline
        function registerBackgroundSync() {
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('background-sync-readings');
                }).catch(() => {});
            }
        }
        
        // Send push notification (for testing)
        function sendTestNotification() {
            
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in browser settings.');
                return;
            }
            
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showTestNotification();
                    } else {
                        alert('Notification permission denied');
                    }
                });
            } else if (Notification.permission === 'granted') {
                showTestNotification();
            }
        }
        
        function showTestNotification() {
            // Try direct notification first
            try {
                new Notification('Test Notification', {
                    body: 'Direct browser notification test',
                    icon: '/logo192.png'
                });
            } catch (err) {}
            
            // Also try service worker notification
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification(window.APP_TITLE, {
                        body: 'Test notification - this should appear on desktop!',
                        icon: '/logo192.png',
                        badge: '/logo192.png',
                        vibrate: [100, 50, 100],
                        tag: 'test-notification',
                        actions: [
                            { action: 'open', title: 'Open App' },
                            { action: 'close', title: 'Close' }
                        ]
                    }).catch(() => {});
                }).catch(() => {});
            }
        }
        
        function fallbackNotification() {
            new Notification(window.APP_TITLE, {
                body: 'Test notification - fallback method',
                icon: '/logo192.png'
            });
        }

        function startNewSession() {
            vibrate([100, 50, 100]);
            if (confirm('Start a new session? This will unload all current data and start over.')) {
                session.startOver();
                resetTimer();
                document.getElementById('timerInput').value = '15';
                showSnackbar('Ready to create new session', 'success');
            }
        }

        async function showLoadSession() {
            if (!session.user) {
                return;
            }
            
            vibrate([50]);
            const btn = document.querySelector('.btn-load-session');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="spinner inline"></span>Loading...';
            btn.classList.add('loading');
            
            try {
                const { data, error } = await supabaseClient
                    .from('blacksheep_reading_tracker_sessions')
                    .select('*')
                    .eq('user_name', session.user)
                    .order('session_date', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (data && data.length > 0) {
                    const sessionsList = document.getElementById('sessionsList');
                    sessionsList.innerHTML = data.map(sessionData => {
                        const readingCount = sessionData.readings ? sessionData.readings.length : 0;
                        const date = new Date(normalizeDate(sessionData.session_date)).toLocaleDateString();
                        const dayOfWeek = new Date(normalizeDate(sessionData.session_date)).toLocaleDateString('en-US', { weekday: 'short' });
                        const baseTotal = sessionData.readings ? sessionData.readings.reduce((sum, r) => sum + (r.price || sessionData.reading_price || 0), 0) : 0;
                        const tipsTotal = sessionData.readings ? sessionData.readings.reduce((sum, reading) => sum + (reading.tip || 0), 0) : 0;
                        const grandTotal = baseTotal + tipsTotal;
                        return `
                            <div class="session-item" onclick="selectSession('${sessionData.id}')">
                                <div class="session-info">${sessionData.location || 'No location'} - ${dayOfWeek} ${date}</div>
                                <div class="session-details">${readingCount} readings • $${grandTotal.toFixed(2)}</div>
                            </div>
                        `;
                    }).join('');
                    showSheet('sessionOverlay', 'sessionSheet');
                } else {
                    showSnackbar('No existing sessions found', 'error');
                }
            } catch (error) {
                showSnackbar('Failed to load sessions', 'error');
            } finally {
                btn.textContent = originalText;
                btn.classList.remove('loading');
            }
        }

        function closeSessionSheet() {
            vibrate([30]);
            hideSheet('sessionOverlay', 'sessionSheet');
        }

        async function selectSession(sessionId) {
            vibrate([50]);
            const sessionItem = event.target.closest('.session-item');
            const originalHTML = sessionItem.innerHTML;
            sessionItem.innerHTML = '<div class="session-info"><span class="spinner"></span>Loading session...</div>';
            sessionItem.style.pointerEvents = 'none';
            
            try {
                const { data, error } = await supabaseClient
                    .from('blacksheep_reading_tracker_sessions')
                    .select('*')
                    .eq('id', sessionId)
                    .single();
                
                if (data) {
                    await loadExistingSession(data);
                    closeSessionSheet();
                } else {
                    showSnackbar('Session not found', 'error');
                }
            } catch (error) {
                showSnackbar('Failed to load session', 'error');
            } finally {
                sessionItem.innerHTML = originalHTML;
                sessionItem.style.pointerEvents = 'auto';
            }
        }

        async function loadExistingSession(sessionData) {
            console.log('Loading session data:', sessionData);
            session._loading = true;
            session.sessionId = sessionData.id;
            session.user = sessionData.user_name || '';
            session.location = sessionData.location || '';
            session.sessionDate = sessionData.session_date || '';
            session.price = sessionData.reading_price || 40;
            session.readings = sessionData.readings || [];
            session._loading = false;
            collapseSettings();
            showSnackbar(`Loaded session: ${sessionData.location} on ${sessionData.session_date}`);
        }

        async function createSession() {
            if (!session.canCreateSession) {
                showSnackbar('User, location and date are required', 'error');
                return;
            }
            
            vibrate([50]);
            const btn = document.querySelector('.btn-create-session');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="spinner inline"></span>Creating...';
            btn.classList.add('loading');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data } = await supabaseClient
                    .from('blacksheep_reading_tracker_sessions')
                    .select('*')
                    .eq('session_date', session.sessionDate)
                    .eq('user_name', session.user)
                    .eq('location', session.location)
                    .limit(1);
                
                if (data && data[0]) {
                    btn.textContent = originalText;
                    btn.classList.remove('loading');
                    const message = `${session.location} on ${session.sessionDate} already exists. Load existing session?`;
                    if (confirm(message)) {
                        session.sessionId = data[0].id;
                        session.readings = data[0].readings || [];
                        if (data[0].reading_price) session.price = data[0].reading_price;
                        collapseSettings();
                        showSnackbar(`Loaded existing session: ${session.location} on ${session.sessionDate}`);
                    } else {
                        session.location = '';
                        session.sessionDate = '';
                        showSnackbar('Location and date must be unique', 'error');
                    }
                    return;
                }
                
                const { data: newData } = await supabaseClient
                    .from('blacksheep_reading_tracker_sessions')
                    .insert([{
                        session_date: session.sessionDate,
                        user_name: session.user,
                        location: session.location,
                        reading_price: session.price,
                        readings: session.readings
                    }])
                    .select();
                
                if (newData && newData[0]) {
                    session.sessionId = newData[0].id;
                    session.readings = []; // Clear readings for new session
                    collapseSettings();
                    showSnackbar('Session created successfully!');
                    
                    // Schedule reminder notification for session end (optional)
                    if ('serviceWorker' in navigator && Notification.permission === 'granted' && !isDevelopmentMode()) {
                        setTimeout(() => {
                            sendTestNotification();
                        }, 4 * 60 * 60 * 1000); // 4 hours later
                    }
                }
            } catch (error) {
                showSnackbar('Database error, using offline mode', 'error');
                registerBackgroundSync();
            } finally {
                btn.textContent = originalText;
                btn.classList.remove('loading');
            }
        }

        async function addReading() {
            if (!session.hasValidSession) {
                showSnackbar('Create session first', 'error');
                return;
            }
            
            vibrate([50]);
            const now = new Date();
            const timestamp = now.toISOString();
            session.addReading({ timestamp, tip: 0, price: session.price });
            
            // Trigger background backup after adding reading
            handleBackgroundBackup();
            
            // Skip analytics notifications during active session
        }

        function removeReading() {
            vibrate([50]);
            if (session.readings.length > 0) {
                const lastReading = session.readings[session.readings.length - 1];
                if (confirm(`Delete the ${lastReading.timestamp} reading?`)) {
                    vibrate([100, 50, 100]);
                    session.removeReading(session.readings.length - 1);
                }
            }
        }

        function updatePayment(index, method) {
            vibrate([30]);
            session.updateReading(index, 'payment', method);
        }

        let currentPaymentIndex = null;
        let currentSourceIndex = null;

        function showSheet(overlayId, sheetId) {
            document.getElementById(overlayId).style.display = 'block';
            document.getElementById(sheetId).style.display = 'block';
        }

        function hideSheet(overlayId, sheetId) {
            document.getElementById(overlayId).style.display = 'none';
            document.getElementById(sheetId).style.display = 'none';
        }

        function openPaymentSheet(index) {
            vibrate([30]);
            currentPaymentIndex = index;
            
            // Populate payment options from settings
            const paymentOptions = document.getElementById('paymentOptions');
            const methods = settings.get('paymentMethods');
            paymentOptions.innerHTML = methods.map(method => 
                `<button class="payment-option" onclick="selectPaymentMethod('${method}')">${method}</button>`
            ).join('') + '<button class="payment-option" onclick="selectCustomPayment()">Other</button>';
            
            showSheet('paymentOverlay', 'paymentSheet');
        }

        function closePaymentSheet() {
            vibrate([30]);
            hideSheet('paymentOverlay', 'paymentSheet');
            currentPaymentIndex = null;
        }

        function selectPaymentMethod(method) {
            vibrate([30]);
            if (currentPaymentIndex !== null) {
                session.updateReading(currentPaymentIndex, 'payment', method);
                closePaymentSheet();
            }
        }

        function selectCustomPayment() {
            vibrate([30]);
            const currentValue = currentPaymentIndex !== null && session.readings[currentPaymentIndex].payment ? session.readings[currentPaymentIndex].payment : '';
            const newValue = prompt('Enter payment method:', currentValue);
            if (newValue !== null && newValue.trim()) {
                session.updateReading(currentPaymentIndex, 'payment', newValue.trim());
                closePaymentSheet();
            }
        }

        function openSourceSheet(index) {
            vibrate([30]);
            currentSourceIndex = index;
            
            const sourceOptions = document.getElementById('sourceOptions');
            const sources = settings.get('sources');
            sourceOptions.innerHTML = sources.map(source => 
                `<button class="payment-option" onclick="selectSource('${source}')">${source}</button>`
            ).join('') + '<button class="payment-option" onclick="selectCustomSource()">Other</button>';
            
            showSheet('sourceOverlay', 'sourceSheet');
        }

        function closeSourceSheet() {
            vibrate([30]);
            hideSheet('sourceOverlay', 'sourceSheet');
            currentSourceIndex = null;
        }

        function selectSource(source) {
            vibrate([30]);
            if (currentSourceIndex !== null) {
                session.updateReading(currentSourceIndex, 'source', source);
                closeSourceSheet();
            }
        }

        function selectCustomSource() {
            vibrate([30]);
            const currentValue = currentSourceIndex !== null && session.readings[currentSourceIndex].source ? session.readings[currentSourceIndex].source : '';
            const newValue = prompt('Enter source:', currentValue);
            if (newValue !== null && newValue.trim()) {
                session.updateReading(currentSourceIndex, 'source', newValue.trim());
                closeSourceSheet();
            }
        }



        function deleteReading(index) {
            vibrate([50]);
            const reading = session.readings[index];
            const displayTime = session.formatTimestamp(reading.timestamp);
            if (confirm(`Delete the ${displayTime} reading?`)) {
                vibrate([100, 50, 100]);
                session.removeReading(index);
            }
        }




        function collapseSettings() {
            const content = document.getElementById('settingsContent');
            const icon = document.querySelector('.collapse-icon');
            content.classList.remove('open');
            icon.classList.remove('open');
        }

        function toggleSettings() {
            vibrate([50]);
            const content = document.getElementById('settingsContent');
            const icon = document.querySelector('.collapse-icon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        let timerInterval = null;
        let timerSeconds = 900; // 15 minutes default
        let isRunning = false;
        let isBlinking = false;
        let alarmInterval = null;
        let audioContext = null;
        let wakeLock = null;
        let silentAudio = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBeep(frequency = 1000, duration = 0.15) {
            if (!settings.get('sound')) return;
            
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playAlarmSequence() {
            if (!settings.get('sound')) return;
            
            // Three rapid beeps
            playBeep(1000, 0.1);
            setTimeout(() => playBeep(1000, 0.1), 150);
            setTimeout(() => playBeep(1000, 0.1), 300);
            // Longer tone after gap
            setTimeout(() => playBeep(1000, 0.4), 600);
        }

        function vibrate(pattern) {
            if (navigator.vibrate && settings.get('haptic')) {
                navigator.vibrate(pattern);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ãƒâ€”</button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        function showSnackbar(message, type = 'info') {
            const snackbar = document.createElement('div');
            snackbar.className = `snackbar ${type}`;
            snackbar.textContent = message;
            document.body.appendChild(snackbar);
            
            setTimeout(() => {
                if (snackbar.parentElement) {
                    snackbar.remove();
                }
            }, 2000);
        }
        
        function showUpdateNotification() {
            const updateBar = document.createElement('div');
            updateBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #007bff;
                color: white;
                padding: 12px;
                text-align: center;
                z-index: 10000;
                font-size: 14px;
            `;
            updateBar.innerHTML = `
                New version available! 
                <button onclick="updateApp()" style="background: white; color: #007bff; border: none; padding: 4px 8px; margin-left: 8px; border-radius: 4px; cursor: pointer;">Update Now</button>
                <button onclick="this.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 4px 8px; margin-left: 4px; border-radius: 4px; cursor: pointer;">Later</button>
            `;
            document.body.appendChild(updateBar);
        }
        
        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    } else {
                        // Force reload if no waiting worker
                        window.location.reload(true);
                    }
                }).catch(() => {
                    // Fallback to hard reload
                    window.location.reload(true);
                });
            } else {
                window.location.reload(true);
            }
        }

        function checkForUpdates() {
            if (settings.get('haptic')) vibrate([50]);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        showSnackbar('Checking for updates...', 'info');
                        registration.update().then(() => {
                            setTimeout(() => {
                                showSnackbar('No updates available', 'success');
                            }, 1000);
                        }).catch(() => {
                            showSnackbar('Update check failed', 'error');
                        });
                    } else {
                        showSnackbar('Service worker not available', 'error');
                    }
                }).catch(() => {
                    showSnackbar('Update check failed', 'error');
                });
            } else {
                showSnackbar('Updates not supported', 'error');
            }
        }

        function clearCache() {
            if (settings.get('haptic')) vibrate([50]);
            
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                showSnackbar('Cache cleared! Reloading...', 'success');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            } else {
                showSnackbar('Service worker not available', 'error');
            }
        }

        function startAlarm() {
            playAlarmSequence();
            alarmInterval = setInterval(() => {
                playAlarmSequence();
            }, 1500);
        }

        function stopAlarm() {
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
        }

        function adjustTime(minutes) {
            timer.adjustTime(minutes);
        }

        function initCanvas() {
            canvas = document.getElementById('timerCanvas');
            ctx = canvas.getContext('2d');
            // Ensure crisp lines
            ctx.imageSmoothingEnabled = false;
            drawTimer();
        }

        function drawTimer() {
            if (!ctx) return;
            
            const centerX = 150;
            const centerY = 150;
            const radius = 120;
            
            // Clear canvas
            ctx.clearRect(0, 0, 300, 300);
            
            // Background circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 12;
            ctx.stroke();
            
            // Progress arc
            if (isRunning) {
                // When running: show actual progress with gradient colors
                const progress = timerSeconds / totalSeconds;
                if (progress > 0) {
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + (2 * Math.PI * progress));
                    
                    // Calculate gradient color (green to red)
                    const red = Math.round(220 * (1 - progress) + 40 * progress);
                    const green = Math.round(167 * progress + 53 * (1 - progress));
                    const blue = Math.round(69 * (1 - progress));
                    ctx.strokeStyle = `rgb(${red}, ${green}, ${blue})`;
                    
                    ctx.lineWidth = 12;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }
            } else {
                // When not running: always show full green circle
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#28a745'; // Always green
                ctx.lineWidth = 12;
                ctx.stroke();
            }
            
            // Time text
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Text color
            if (isRunning) {
                const progress = timerSeconds / totalSeconds;
                const red = Math.round(51 * (1 - progress) + 220 * (1 - progress));
                const green = Math.round(51 * progress + 53 * (1 - progress));
                const blue = Math.round(51 * (1 - progress));
                ctx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
            } else {
                ctx.fillStyle = '#333'; // Dark gray when not running
            }
            ctx.font = 'bold 72px monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(timeText, centerX, centerY);
            
            // Animate if running
            if (isRunning) {
                canvasAnimationId = requestAnimationFrame(drawTimer);
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update canvas
            if (canvas) {
                drawTimer();
            }
        }

        let keepAwakeInterval = null;
        let canvasAnimationId = null;
        let canvas = null;
        let ctx = null;
        let totalSeconds = 900;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
            }
            
            // Always use audio fallback as additional insurance
            try {
                initAudio();
                // Create looping silent audio
                const buffer = audioContext.createBuffer(1, 1, 22050);
                silentAudio = audioContext.createBufferSource();
                silentAudio.buffer = buffer;
                silentAudio.loop = true;
                const gainNode = audioContext.createGain();
                silentAudio.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.001, audioContext.currentTime); // Very quiet but not silent
                silentAudio.start();
            } catch (audioErr) {
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            if (silentAudio) {
                silentAudio.stop();
                silentAudio = null;
            }
            if (keepAwakeInterval) {
                clearInterval(keepAwakeInterval);
                keepAwakeInterval = null;
                document.body.style.transform = '';
            }
        }

        function startTimer() {
            timer.start();
        }

        function pauseTimer() {
            timer.pause();
        }

        function resetTimer(showToastMessage = false) {
            timer.reset(showToastMessage);
        }

        function startBlinking() {
            isBlinking = true;
            document.getElementById('timerDisplay').classList.add('blink');
        }

        function stopBlinking() {
            isBlinking = false;
            document.getElementById('timerDisplay').classList.remove('blink');
        }

        function startWarningBlink() {
            document.getElementById('timerDisplay').classList.add('warning');
        }

        function stopWarningBlink() {
            document.getElementById('timerDisplay').classList.remove('warning');
        }

        // Initialize audio context on first user interaction
        document.addEventListener('click', initAudio, { once: true });

        document.getElementById('timerInput').addEventListener('input', function() {
            if (!timer.isRunning) {
                timer.seconds = parseInt(this.value) * 60;
            }
        });

        // Initialize canvas on page load
        window.addEventListener('load', function() {
            timer.initCanvas();
            
            // Set default timer from settings
            const defaultMinutes = settings.get('defaultTimer');
            document.getElementById('timerInput').value = defaultMinutes;
            timer.seconds = defaultMinutes * 60;
            
            // Set buddy logo and header logo
            document.getElementById('buddyLogo').src = window.APP_LOGO;
            document.getElementById('gpsyHeaderLogo').src = window.APP_LOGO;
        });

        document.getElementById('price').addEventListener('input', function() {
            session.price = parseFloat(this.value) || 0;
        });

        async function showUserSelection() {
            vibrate([30]);
            showSheet('userOverlay', 'userSheet');
            
            const userList = document.getElementById('userList');
            userList.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div></div>';
            
            await session.loadUsers();
        }
        
        function hideUserSelection() {
            vibrate([30]);
            hideSheet('userOverlay', 'userSheet');
        }
        
        function selectUser(userName) {
            vibrate([50]);
            
            // Check if switching users during active session
            if (session.hasValidSession && session.user && session.user !== userName) {
                const message = `Switching users will unload the current session (${session.location} on ${session.sessionDate}). Continue?`;
                if (!confirm(message)) {
                    return;
                }
            }
            
            // Overwrite localStorage with clean user object
            localStorage.setItem(`readingTracker_${userName}`, JSON.stringify({
                user: userName,
                sessionId: null,
                location: '',
                selectedDay: null,
                price: 40,
                readings: []
            }));
            
            session.user = userName;
            session.loadFromStorage();
            hideUserSelection();
        }
        
        document.getElementById('location').addEventListener('input', function() {
            session.location = this.value;
        });
        
        document.getElementById('sessionDate').addEventListener('input', function() {
            session.sessionDate = this.value;
        });
        
        function addNewUser() {
            vibrate([50]);
            const userName = prompt('Enter new user name:');
            if (userName && userName.trim()) {
                const trimmedName = userName.trim();
                session.user = trimmedName;
                hideUserSelection();
            }
        }

        function handleCreateSession() {
            const createBtn = document.querySelector('.btn-create-session');
            if (createBtn.classList.contains('inactive')) {
                showSnackbar('User, location and date are required', 'error');
                vibrate([50]);
            } else {
                createSession();
            }
        }

        // Settings Drawer Functions
        function openSettingsDrawer() {
            vibrate([50]);
            document.getElementById('settingsOverlay').classList.add('open');
            document.getElementById('settingsDrawer').classList.add('open');
            settings.updateToggleUI();
        }

        function closeSettingsDrawer() {
            vibrate([30]);
            document.getElementById('settingsOverlay').classList.remove('open');
            document.getElementById('settingsDrawer').classList.remove('open');
            // Also close any open payment methods sheet
            closePaymentMethodsSheet();
        }

        function toggleSetting(key) {
            if (settings.get('haptic')) vibrate([30]);
            settings.toggle(key);
            
            // Special handling for certain settings
            if (key === 'defaultTimer') {
                const minutes = settings.get('defaultTimer');
                document.getElementById('timerInput').value = minutes;
                timer.seconds = minutes * 60;
            }
        }

        function updateSetting(key, value) {
            if (settings.get('haptic')) vibrate([30]);
            if (key === 'defaultTimer') {
                settings.set(key, parseInt(value));
                document.getElementById('timerInput').value = value;
                timer.seconds = parseInt(value) * 60;
            } else {
                settings.set(key, value);
            }
        }

        function customizePaymentMethods() {
            if (settings.get('haptic')) vibrate([50]);
            showPaymentMethodsSheet();
        }
        
        function showPaymentMethodsSheet() {
            const methods = settings.get('paymentMethods');
            const list = document.getElementById('paymentMethodsList');
            if (!list) return;
            
            list.innerHTML = methods.map((method, index) => `
                <div class="payment-method-item">
                    <input type="text" class="payment-method-input" value="${method}" 
                           onchange="updatePaymentMethod(${index}, this.value)">
                    <button class="payment-method-delete" onclick="deletePaymentMethod(${index})">Delete</button>
                </div>
            `).join('');
            showSheet('paymentMethodsOverlay', 'paymentMethodsSheet');
        }
        
        function closePaymentMethodsSheet() {
            if (settings.get('haptic')) vibrate([30]);
            hideSheet('paymentMethodsOverlay', 'paymentMethodsSheet');
        }
        
        function updatePaymentMethod(index, value) {
            if (settings.get('haptic')) vibrate([30]);
            const methods = [...settings.get('paymentMethods')];
            methods[index] = value.trim();
            settings.set('paymentMethods', methods.filter(m => m));
            showSnackbar('Setting saved', 'success');
        }
        
        function deletePaymentMethod(index) {
            if (settings.get('haptic')) vibrate([50]);
            const methods = [...settings.get('paymentMethods')];
            methods.splice(index, 1);
            settings.set('paymentMethods', methods);
            showPaymentMethodsSheet(); // Refresh the list
        }
        
        function addPaymentMethod() {
            if (settings.get('haptic')) vibrate([50]);
            const methods = [...settings.get('paymentMethods')];
            methods.push('New Method');
            settings.set('paymentMethods', methods);
            showPaymentMethodsSheet(); // Refresh the list
        }

        function customizeSources() {
            if (settings.get('haptic')) vibrate([50]);
            showSourcesSheet();
        }
        
        function showSourcesSheet() {
            const sources = settings.get('sources');
            const list = document.getElementById('sourcesList');
            if (!list) return;
            
            list.innerHTML = sources.map((source, index) => `
                <div class="payment-method-item">
                    <input type="text" class="payment-method-input" value="${source}" 
                           onchange="updateSource(${index}, this.value)">
                    <button class="payment-method-delete" onclick="deleteSource(${index})">Delete</button>
                </div>
            `).join('');
            showSheet('sourcesOverlay', 'sourcesSheet');
        }
        
        function closeSourcesSheet() {
            if (settings.get('haptic')) vibrate([30]);
            hideSheet('sourcesOverlay', 'sourcesSheet');
        }
        
        function updateSource(index, value) {
            if (settings.get('haptic')) vibrate([30]);
            const sources = [...settings.get('sources')];
            sources[index] = value.trim();
            settings.set('sources', sources.filter(s => s));
            showSnackbar('Setting saved', 'success');
        }
        
        function deleteSource(index) {
            if (settings.get('haptic')) vibrate([50]);
            const sources = [...settings.get('sources')];
            sources.splice(index, 1);
            settings.set('sources', sources);
            showSourcesSheet(); // Refresh the list
        }
        
        function addSource() {
            if (settings.get('haptic')) vibrate([50]);
            const sources = [...settings.get('sources')];
            sources.push('New Source');
            settings.set('sources', sources);
            showSourcesSheet(); // Refresh the list
        }

        async function exportData() {
            if (!session.user) {
                showSnackbar('Select a user first', 'error');
                return;
            }
            
            if (settings.get('haptic')) vibrate([50]);
            
            try {
                const { data } = await supabaseClient
                    .from('blacksheep_reading_tracker_sessions')
                    .select('*')
                    .eq('user_name', session.user)
                    .order('session_date', { ascending: false });
                
                if (!data || data.length === 0) {
                    showSnackbar('No data to export', 'error');
                    return;
                }
                
                // Convert to CSV
                const csvData = [];
                csvData.push(['Date', 'User', 'Location', 'Day', 'Reading Price', 'Readings Count', 'Base Total', 'Tips Total', 'Grand Total']);
                
                data.forEach(sessionData => {
                    const readingCount = sessionData.readings ? sessionData.readings.length : 0;
                    const baseTotal = readingCount * (sessionData.reading_price || 0);
                    const tipsTotal = sessionData.readings ? sessionData.readings.reduce((sum, r) => sum + (r.tip || 0), 0) : 0;
                    const grandTotal = baseTotal + tipsTotal;
                    
                    csvData.push([
                        sessionData.session_date,
                        sessionData.user_name,
                        sessionData.location,
                        sessionData.session_date,
                        sessionData.reading_price,
                        readingCount,
                        baseTotal.toFixed(2),
                        tipsTotal.toFixed(2),
                        grandTotal.toFixed(2)
                    ]);
                });
                
                const csvContent = csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `tarot-sessions-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                URL.revokeObjectURL(url);
                showSnackbar('Data exported successfully', 'success');
            } catch (error) {
                showSnackbar('Export failed', 'error');
            }
        }



        // Check for saved session on page load
        window.addEventListener('load', async function() {
            const saved = localStorage.getItem('readingTracker');
            if (saved) {
                const state = JSON.parse(saved);
                const location = state.location || 'Unknown location';
                const date = state.sessionDate || state.selectedDay || 'Unknown date';
                const message = `I have saved data from ${location} on ${date}. Would you like to load that data? (OK) or start a new session? (Cancel)`;
                if (confirm(message)) {
                    session.loadFromStorage();
                } else {
                    session.startOver();
                }
            } else {
                // Initialize UI on first load
                session.updateUI();
            }
        });

        // Close sheets when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('sessionOverlay')) {
                closeSessionSheet();
            }
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            handleBackgroundSync();
        });
        
        window.addEventListener('offline', () => {
            registerBackgroundSync();
        });
        
        // Page visibility change - backup data when app goes to background (throttled)
        let lastBackupTime = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                const now = Date.now();
                // Only backup once per minute to prevent spam
                if (now - lastBackupTime > 60000) {
                    handleBackgroundBackup();
                    lastBackupTime = now;
                }
            }
        });
        
        // Development mode detection
        function isDevelopmentMode() {
            return window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.hostname.startsWith('192.168.') ||
                   window.location.hostname.startsWith('10.') ||
                   window.location.port === '8080' ||
                   window.location.protocol === 'file:' ||
                   window.location.search.includes('dev=true');
        }
        

    </script>
    
    <script src="session-store.js"></script>
    <script src="gpsy-chat.js"></script>
    
    <script>
        // ========================================
        // INITIALIZATION
        const settings = new SettingsStore();
        const session = new SessionStore();
        const timer = new Timer();
        const gpsyChat = new GpsyChat();
        
        // Expose globally for inline handlers
        window.session = session;
        window.timer = timer;
        window.gpsyChat = gpsyChat;
    </script>
</body>
</html>
